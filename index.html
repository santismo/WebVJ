<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>YouTube Overlay VJ</title>
  <style>
    :root{
      --bg:#07080c;
      --panel:#0f1118;
      --panel2:#0b0d13;
      --text:#eef1f7;
      --muted:#a9b0bf;
      --border:rgba(255,255,255,.10);
      --accent:#7aa2ff;
      --maxw:1100px;
      --radius:14px;
    }
    html,body{background:var(--bg); color:var(--text); margin:0; font-family:system-ui,-apple-system,sans-serif;}
    .wrap{max-width:var(--maxw); margin:18px auto; padding:0 14px; display:grid; gap:12px;}
    h1{font-size:18px; margin:0;}
    .topbar{display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;}
    .btnrow{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    button{
      background:var(--panel);
      color:var(--text);
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px 12px;
      font-size:15px;
    }
    button.primary{
      border-color:rgba(122,162,255,.55);
      box-shadow:0 0 0 2px rgba(122,162,255,.10) inset;
    }
    button.ghost{background:transparent}
    .hint{font-size:12px; color:var(--muted);}

    .stage{
      position:relative;
      width:min(96vw,var(--maxw));
      aspect-ratio:16/9;
      border-radius:var(--radius);
      overflow:hidden;
      background:#000;
      border:1px solid var(--border);
    }
    /* When fullscreen, let it fill the display */
    .stage:fullscreen{
      width:100vw;
      height:100vh;
      aspect-ratio:auto;
      border-radius:0;
      border:none;
    }

    .layer{
      position:absolute; inset:0;
      transform-origin:50% 50%;
      pointer-events:none;
      will-change: transform, filter, opacity;
    }
    .layer.base{pointer-events:auto;}
    .layer iframe{width:100%; height:100%; border:0; display:block;}

    .playOverlay{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      background:linear-gradient(to bottom, rgba(0,0,0,.20), rgba(0,0,0,.65));
      backdrop-filter: blur(2px);
      opacity:0;
      pointer-events:none;
      transition:opacity .2s ease;
    }
    .playOverlay.show{
      opacity:1;
      pointer-events:auto;
    }
    .playOverlay button{
      font-size:16px;
      padding:12px 16px;
      border-radius:999px;
      background:rgba(15,17,24,.75);
      border:1px solid rgba(122,162,255,.6);
    }

    .panel{
      background:var(--panel2);
      border:1px solid var(--border);
      border-radius:var(--radius);
      overflow:hidden;
    }
    .panelHead{
      display:flex; align-items:center; justify-content:space-between;
      padding:12px;
      gap:10px;
      border-bottom:1px solid var(--border);
    }
    .panelBody{padding:12px; display:none;}
    .panel.open .panelBody{display:block;}

    .mini{display:flex; gap:8px; flex-wrap:wrap; align-items:center; color:var(--muted); font-size:12px;}
    .pill{
      border:1px solid var(--border);
      padding:3px 8px;
      border-radius:999px;
      background:rgba(255,255,255,.03);
    }

    .card{
      border:1px solid var(--border);
      border-radius:var(--radius);
      background:rgba(255,255,255,.02);
      overflow:hidden;
    }
    .cardHead{
      padding:10px 12px;
      display:flex; gap:10px; flex-wrap:wrap;
      align-items:center; justify-content:space-between;
      border-bottom:1px solid var(--border);
    }
    .cardTitle{font-weight:700; font-size:14px;}
    .cardActions{display:flex; gap:8px; flex-wrap:wrap; align-items:center;}
    .row{
      display:grid; gap:10px;
      grid-template-columns:1fr 1fr;
      padding:12px;
    }
    @media (max-width:820px){ .row{grid-template-columns:1fr;} }
    label{display:grid; gap:6px; font-size:13px; color:var(--muted);}
    input[type="text"], select{
      width:100%;
      padding:10px;
      border-radius:12px;
      border:1px solid var(--border);
      background:rgba(0,0,0,.30);
      color:var(--text);
      font-size:15px;
      outline:none;
    }
    input[type="range"]{width:100%;}
    .toggle{display:flex; gap:8px; align-items:center; color:var(--muted); font-size:13px; user-select:none;}
    .toggle input{transform:scale(1.05)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <h1>YouTube Overlay VJ</h1>
        <div class="hint">Defaults: 2 videos • overlay blend = <b>difference</b> • all other FX off • autoplay attempted (muted)</div>
      </div>
      <div class="btnrow">
        <button id="reloadBtn" class="ghost">Reload</button>
        <button id="playBtn" class="primary">Play</button>
        <button id="pauseBtn">Pause</button>
        <button id="fsBtn">Fullscreen</button>
        <button id="controlsBtn">Expand controls</button>
      </div>
    </div>

    <div class="stage" id="stage">
      <div id="layer0" class="layer base"></div>
      <div id="layer1" class="layer"></div>

      <div class="playOverlay" id="playOverlay">
        <button id="tapPlayBtn">Tap to Play</button>
      </div>
    </div>

    <div class="panel" id="controlsPanel">
      <div class="panelHead">
        <div class="mini">
          <span class="pill">2 layers (fixed)</span>
          <span class="pill">blend + filters only</span>
          <span class="pill">fullscreen stage</span>
        </div>
        <div class="btnrow">
          <button id="hidePanelBtn" class="ghost">Hide</button>
        </div>
      </div>

      <div class="panelBody">
        <div class="card">
          <div class="cardHead">
            <div class="cardTitle">Layer 1 (base)</div>
            <div class="cardActions">
              <button id="mute0Btn">Unmute</button>
            </div>
          </div>
          <div class="row">
            <label>URL
              <input id="url0" type="text">
            </label>
            <label>Opacity
              <input id="op0" type="range" min="0" max="1" step="0.01" value="1">
            </label>
          </div>
        </div>

        <div class="card" style="margin-top:12px;">
          <div class="cardHead">
            <div class="cardTitle">Layer 2 (overlay)</div>
            <div class="cardActions">
              <button id="mute1Btn">Unmute</button>
            </div>
          </div>
          <div class="row">
            <label>URL
              <input id="url1" type="text">
            </label>

            <label>Blend mode
              <select id="blend1"></select>
            </label>

            <label>Opacity
              <input id="op1" type="range" min="0" max="1" step="0.01" value="0.85">
            </label>

            <label>Invert
              <input id="inv1" type="range" min="0" max="1" step="0.01" value="0">
            </label>

            <label>Contrast
              <input id="ct1" type="range" min="0.5" max="3.0" step="0.01" value="1.4">
            </label>

            <label>Brightness
              <input id="br1" type="range" min="0.2" max="2.0" step="0.01" value="1.0">
            </label>

            <label>Saturation
              <input id="sat1" type="range" min="0" max="3.0" step="0.01" value="0.9">
            </label>

            <label>Hue rotate
              <input id="hu1" type="range" min="0" max="360" step="1" value="0">
            </label>

            <label>Blur (px)
              <input id="bl1" type="range" min="0" max="12" step="0.1" value="0">
            </label>
          </div>
        </div>

        <div class="hint" style="padding:12px 2px 0;">
          Note: autoplay on iOS may still require a user tap. Fullscreen must be triggered by a tap.
        </div>
      </div>
    </div>
  </div>

  <script src="https://www.youtube.com/iframe_api"></script>
  <script>
    let player0 = null, player1 = null;
    let muted0 = true, muted1 = true;

    const DEFAULT0 = "https://m.youtube.com/watch?v=3pxrECZYEAA&pp=ygUOdmlzdWFscyB0cmlwcHk%3D";
    const DEFAULT1 = "https://m.youtube.com/watch?v=dS-MaUk6YBI";

    const blendModes = [
      "normal","multiply","screen","overlay","darken","lighten","color-dodge","color-burn",
      "hard-light","soft-light","difference","exclusion","hue","saturation","color","luminosity"
    ];

    function extractVideoId(url) {
      if (!url) return null;
      const raw = url.trim();
      if (/^[a-zA-Z0-9_-]{11}$/.test(raw)) return raw;
      try {
        const u = new URL(raw);
        if (u.hostname.includes("youtu.be")) return u.pathname.replace("/", "") || null;
        const v = u.searchParams.get("v");
        if (v) return v;
        const parts = u.pathname.split("/").filter(Boolean);
        const embedIdx = parts.indexOf("embed");
        if (embedIdx >= 0 && parts[embedIdx + 1]) return parts[embedIdx + 1];
      } catch (e) {}
      return null;
    }

    function mountPlayer(layerIndex, videoId) {
      const layer = document.getElementById(`layer${layerIndex}`);
      layer.innerHTML = `<div id="player${layerIndex}"></div>`;
      return new YT.Player(`player${layerIndex}`, {
        videoId,
        playerVars: { playsinline: 1, rel: 0 },
        events: {
          onReady: (e) => {
            // keep muted for autoplay compatibility
            try { e.target.mute(); } catch(e) {}
          }
        }
      });
    }

    function applyCSS() {
      // base opacity only
      document.getElementById("layer0").style.opacity = document.getElementById("op0").value;

      // overlay compositing
      const layer1 = document.getElementById("layer1");
      layer1.style.opacity = document.getElementById("op1").value;
      layer1.style.mixBlendMode = document.getElementById("blend1").value;

      const inv = document.getElementById("inv1").value;
      const ct  = document.getElementById("ct1").value;
      const br  = document.getElementById("br1").value;
      const sat = document.getElementById("sat1").value;
      const hu  = document.getElementById("hu1").value;
      const bl  = document.getElementById("bl1").value;

      layer1.style.filter =
        `invert(${inv}) contrast(${ct}) brightness(${br}) saturate(${sat}) hue-rotate(${hu}deg) blur(${bl}px)`;
    }

    async function tryAutoplayMuted() {
      let attempted = false;
      try { if (player0) { player0.mute(); player0.playVideo(); attempted = true; } } catch(e) {}
      try { if (player1) { player1.mute(); player1.playVideo(); attempted = true; } } catch(e) {}
      // If autoplay fails, user will still see the overlay button
      return attempted;
    }

    function playAll() {
      try { player0 && player0.mute(); } catch(e) {}
      try { player1 && player1.mute(); } catch(e) {}
      try { player0 && player0.playVideo(); } catch(e) {}
      try { player1 && player1.playVideo(); } catch(e) {}
      document.getElementById("playOverlay").classList.remove("show");
    }

    function pauseAll() {
      try { player0 && player0.pauseVideo(); } catch(e) {}
      try { player1 && player1.pauseVideo(); } catch(e) {}
    }

    function loadAll() {
      const url0 = document.getElementById("url0").value;
      const url1 = document.getElementById("url1").value;
      const id0 = extractVideoId(url0);
      const id1 = extractVideoId(url1);

      if (!id0 || !id1) {
        alert("Please provide two valid YouTube URLs (or 11-char IDs).");
        return;
      }

      // Destroy existing
      if (player0 && player0.destroy) { try { player0.destroy(); } catch(e) {} }
      if (player1 && player1.destroy) { try { player1.destroy(); } catch(e) {} }
      player0 = mountPlayer(0, id0);
      player1 = mountPlayer(1, id1);

      applyCSS();

      setTimeout(async () => {
        const attempted = await tryAutoplayMuted();
        // Show tap overlay if we attempted autoplay (still might fail on iOS)
        document.getElementById("playOverlay").classList.toggle("show", !attempted);
      }, 650);
    }

    function toggleMute(which) {
      const p = which === 0 ? player0 : player1;
      if (!p) return;

      if (which === 0) muted0 = !muted0;
      else muted1 = !muted1;

      const muted = which === 0 ? muted0 : muted1;
      const btn = document.getElementById(which === 0 ? "mute0Btn" : "mute1Btn");

      try { muted ? p.mute() : p.unMute(); } catch(e) {}
      btn.textContent = muted ? "Unmute" : "Mute";
    }

    async function goFullscreen() {
      const stage = document.getElementById("stage");
      try {
        if (document.fullscreenElement) {
          await document.exitFullscreen();
        } else {
          await stage.requestFullscreen();
        }
      } catch (e) {
        alert("Fullscreen not available in this browser (or it must be triggered by a tap).");
      }
    }

    // Panel toggle
    const controlsPanel = document.getElementById("controlsPanel");
    document.getElementById("controlsBtn").addEventListener("click", () => {
      controlsPanel.classList.toggle("open");
      document.getElementById("controlsBtn").textContent =
        controlsPanel.classList.contains("open") ? "Collapse controls" : "Expand controls";
    });
    document.getElementById("hidePanelBtn").addEventListener("click", () => {
      controlsPanel.classList.remove("open");
      document.getElementById("controlsBtn").textContent = "Expand controls";
    });

    // Buttons
    document.getElementById("reloadBtn").addEventListener("click", loadAll);
    document.getElementById("playBtn").addEventListener("click", playAll);
    document.getElementById("pauseBtn").addEventListener("click", pauseAll);
    document.getElementById("tapPlayBtn").addEventListener("click", playAll);
    document.getElementById("fsBtn").addEventListener("click", goFullscreen);

    document.getElementById("mute0Btn").addEventListener("click", () => toggleMute(0));
    document.getElementById("mute1Btn").addEventListener("click", () => toggleMute(1));

    // Wire controls -> CSS
    ["op0","op1","blend1","inv1","ct1","br1","sat1","hu1","bl1"].forEach(id => {
      document.getElementById(id).addEventListener("input", applyCSS);
      document.getElementById(id).addEventListener("change", applyCSS);
    });

    // Fill defaults + blend default = difference
    document.getElementById("url0").value = DEFAULT0;
    document.getElementById("url1").value = DEFAULT1;
    const blendSel = document.getElementById("blend1");
    blendSel.innerHTML = blendModes.map(m => `<option value="${m}">${m}</option>`).join("");
    blendSel.value = "difference";

    // YouTube API ready hook
    function onYouTubeIframeAPIReady() {
      loadAll();
    }
    window.onYouTubeIframeAPIReady = onYouTubeIframeAPIReady;
  </script>
</body>
</html>
